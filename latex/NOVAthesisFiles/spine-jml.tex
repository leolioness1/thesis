%!TEX root = ../template.tex
% Draw the book spine

\typeout{NT FILE spine-jml.tex}

\makeatletter

\newlength{\@nt@spinewidth}%
\setlength{\@nt@spinewidth}{1mm * (\thelastpage + 19) / 20}%

% Make a box with the logo
\newbox{\@nt@spine@box@logo}%
\newlength{\@nt@spine@box@logo@width}%
\newlength{\@nt@spine@box@logo@height}%
\newcommand{\@nt@spine@box@logoangle}{-90}%
\newcommand{\make@spine@box@logo}[2]{%
  \savebox{\@nt@spine@box@logo}{%
    \includegraphics%
      [origin=c,angle=\@nt@spine@box@logoangle,height=0.95\@nt@spinewidth,#1]%
      {#2}%
  }%
  \settowidth{\@nt@spine@box@logo@width}{\usebox{\@nt@spine@box@logo}}%
  \settoheight{\@nt@spine@box@logo@height}{\usebox{\@nt@spine@box@logo}}%
}

% Make a box with the logo2
\newbox{\@nt@spine@box@logotwo}%
\newlength{\@nt@spine@box@logotwo@width}%
\newlength{\@nt@spine@box@logotwo@height}%
\newcommand{\@nt@spine@box@logotwoangle}{-90}%
\newcommand{\make@spine@box@logotwo}[2]{%
  \savebox{\@nt@spine@box@logotwo}{%
    \includegraphics%
      [origin=c,angle=\@nt@spine@box@logotwoangle,height=0.95\@nt@spinewidth,#1]%
      {#2}%
  }%
  \settowidth{\@nt@spine@box@logotwo@width}{\usebox{\@nt@spine@box@logo}}%
  \settoheight{\@nt@spine@box@logotwo@height}{\usebox{\@nt@spine@box@logo}}%
}

% Make a box with the date
\newbox{\@nt@spine@box@date}%
\newlength{\@nt@spine@box@date@width}%
\newlength{\@nt@spine@box@date@height}%
\newcommand{\make@spine@box@date}{%
  \savebox{\@nt@spine@box@date}{\thespine(year)}%
  \settowidth{\@nt@spine@box@date@width}{\usebox{\@nt@spine@box@date}}%
  \settoheight{\@nt@spine@box@date@height}{\usebox{\@nt@spine@box@date}}%
  \ifdim\@nt@spine@box@date@width < 0.90\@nt@spinewidth%
    \savebox{\@nt@spine@box@date}{%
      \rotatebox[origin=c]{-90}{\usebox{\@nt@spine@box@date}}%
    }%
  \fi%
  \settowidth{\@nt@spine@box@date@width}{\usebox{\@nt@spine@box@date}}%
  \settoheight{\@nt@spine@box@date@height}{\usebox{\@nt@spine@box@date}}%
  \ifdim\@nt@spine@box@date@height > 0.90\@nt@spinewidth%
    \savebox{\@nt@spine@box@date}{%
      \resizebox{!}{0.90\@nt@spinewidth}{\usebox{\@nt@spine@box@date}}%
    }%
  \fi%
  \settowidth{\@nt@spine@box@date@width}{\usebox{\@nt@spine@box@date}}%
  \settoheight{\@nt@spine@box@date@height}{\usebox{\@nt@spine@box@date}}%
}



% Make a box with the title
\newbox{\@nt@spine@box@title}%
\newlength{\@nt@spine@box@title@width}%
\newlength{\@nt@spine@box@title@height}%
\newlength{\@nt@spine@box@middlewidth}%
\newcommand{\make@spine@box@title}[1]{%
  \setlength{\@nt@spine@box@middlewidth}{%
    \dimexpr\linewidth-\@nt@spine@box@logo@width-\@nt@spine@box@date@width%
  }%
  \savebox{\@nt@spine@box@title}{%
    \parbox{#1\@nt@spine@box@middlewidth}{\centering\bfseries\thespine(title)}%
  }%
  \settowidth{\@nt@spine@box@title@width}{\usebox{\@nt@spine@box@title}}%
  \settoheight{\@nt@spine@box@title@height}{\usebox{\@nt@spine@box@title}}%
  \ifdim\@nt@spine@box@title@height > 0.90\@nt@spinewidth%
    \savebox{\@nt@spine@box@title}{%
      \resizebox{!}{0.90\@nt@spinewidth}{\usebox{\@nt@spine@box@title}}%
    }%
  \fi%
  \settowidth{\@nt@spine@box@title@width}{\usebox{\@nt@spine@box@title}}%
  \settoheight{\@nt@spine@box@title@height}{\usebox{\@nt@spine@box@title}}%
}


% Make a box with the author
\newbox{\@nt@spine@box@author}%
\newlength{\@nt@spine@box@author@width}%
\newlength{\@nt@spine@box@author@height}%
\newcommand{\make@spine@box@author}[1]{%
  \savebox{\@nt@spine@box@author}{%
    \parbox{#1\@nt@spine@box@middlewidth}{\centering\thespine(author)}%
  }%
  \settowidth{\@nt@spine@box@author@width}{\usebox{\@nt@spine@box@author}}%
  \settoheight{\@nt@spine@box@author@height}{\usebox{\@nt@spine@box@author}}%
  \ifdim\@nt@spine@box@author@height > 0.90\@nt@spinewidth%
    \savebox{\@nt@spine@box@author}{%
      \resizebox{!}{0.90\@nt@spinewidth}{\usebox{\@nt@spine@box@author}}%
    }%
  \fi%
  \settowidth{\@nt@spine@box@author@width}{\usebox{\@nt@spine@box@author}}%
  \settoheight{\@nt@spine@box@author@height}{\usebox{\@nt@spine@box@author}}%
}


\newbox{\@nt@spine@box@titleauthor}%
\newlength{\@nt@spine@box@titleauthor@width}%
\newlength{\@nt@spine@box@titleauthor@height}%
\newcommand{\make@spine@box@titleauthor}{%
  \make@spine@box@title{0.8}%
  \make@spine@box@author{0.8}%
  \savebox{\@nt@spine@box@titleauthor}{%
    \parbox{0.8\@nt@spine@box@middlewidth}{%
      % \vfill%
      \usebox{\@nt@spine@box@title}%
      \vfill%
      \usebox{\@nt@spine@box@author}%
      % \vfill%
    }%
  }%
  \settowidth{\@nt@spine@box@titleauthor@width}%
    {\usebox{\@nt@spine@box@titleauthor}}%
  \settoheight{\@nt@spine@box@titleauthor@height}%
    {\usebox{\@nt@spine@box@titleauthor}}%
  \ifdim\@nt@spine@box@titleauthor@height > 0.90\@nt@spinewidth%
    \make@spine@box@title{0.4}%
    \make@spine@box@author{0.4}%
    \savebox{\@nt@spine@box@titleauthor}{%
      \usebox{\@nt@spine@box@title}%
      \qquad%
      \usebox{\@nt@spine@box@author}%
    }%
  \fi%
  \settowidth{\@nt@spine@box@titleauthor@width}%
    {\usebox{\@nt@spine@box@titleauthor}}%
  \settoheight{\@nt@spine@box@titleauthor@height}%
    {\usebox{\@nt@spine@box@titleauthor}}%
  \ifdim\@nt@spine@box@titleauthor@height > 0.90\@nt@spinewidth%
    \savebox{\@nt@spine@box@titleauthor}{%
      \resizebox{!}{0.90\@nt@spinewidth}{\usebox{\@nt@spine@box@titleauthor}}%
    }%
  \fi%
  \settowidth{\@nt@spine@box@titleauthor@width}%
    {\usebox{\@nt@spine@box@titleauthor}}%
  \settoheight{\@nt@spine@box@titleauthor@height}%
    {\usebox{\@nt@spine@box@titleauthor}}%
}

\newcommand{\AtStockLowerCenter}[1]{%
  \AtPageUpperLeft{% 
    \put(\LenToUnit{(\paperwidth-\@nt@spinewidth)/2},%
         \LenToUnit{-\paperheight}){#1}%
  }%
}

\newbox{\@nt@spine@box}%
\newcommand{\ntprintspine}{%
  \clearforchapter%
  \thispagestyle{empty}%
  \make@spine@box@logo{}{\thespine(logo)}%
  \ifexists{spine}[logotwo]{%
    \make@spine@box@logotwo{}{\thespine(logotwo)}%
  }
  \make@spine@box@date%
  \make@spine@box@titleauthor%
  \savebox{\@nt@spine@box}{%
    \rotatebox{90}{%
      \framebox[\stockheight]{%
        ~
        \parbox[c][\@nt@spinewidth][c]{\@nt@spine@box@date@width}%
          {\usebox{\@nt@spine@box@date}}%
        \ifexists{spine}[logotwo]{%
          \parbox[c][\@nt@spinewidth][c]{\@nt@spine@box@logotwo@width}%
            {\hspace*{3mm}\usebox{\@nt@spine@box@logotwo}}%
        }
        \hfill%
        \parbox[c][\@nt@spinewidth][c]{\@nt@spine@box@titleauthor@width}%
          {\usebox{\@nt@spine@box@titleauthor}}%
        \hfill%
        \parbox[c][\@nt@spinewidth][c]{\@nt@spine@box@logo@width}%
          {\usebox{\@nt@spine@box@logo}}%
        ~
      }%
    }%
  }%
  % \AddToShipoutPictureFG*{%
  %   \AtStockLowerCenter{%
  %       {\usebox{\@nt@spine@box}}%
  %   }%
  % }%
  \begin{tikzpicture}[remember picture, overlay]
    \node[inner sep=0] at (current page.center) {\usebox{\@nt@spine@box}};
  \end{tikzpicture}
  ~% This space is important here so that the spine page is not empty anymore!
  % \clearforchapter%
}%

\makeatother
